%%{init: {'theme': 'neutral', 'themeVariables': {
    'actorBorder': '#475569',
    'actorBkg': '#f8fafc',
    'actorTextColor': '#0f172a',
    'signalColor': '#1f2937',
    'signalTextColor': '#0f172a'
}}}%%
sequenceDiagram
    %% Color legend: Builder (blue), Holding (gold), Confirm (green), PostShip (purple), Undo/Redo (gray)
    box rgb(222,235,255) Builder setup
        participant Builder as Package Builder sheet
        participant BOM as ShippingBOM lists
        participant invPkg as invSys row (managed package)
    end
    box rgb(255,249,219) Tally + holding
        participant Picker as Shipping picker form
        participant Tally as ShippingTally (list)
        participant Assembly as ShippingAssembly (component view)
        participant ShipAgg as Shipments (package aggregation)
        participant DeleteGuard as Check-on-delete guard
        participant HoldToggle as Unshipped toggle button
        participant SendHoldBtn as Send to NotShipped button
        participant ReturnHoldBtn as Return to Shipments button
        participant HoldList as NotShipped list object
    end
    box rgb(231,250,233) Confirm + logging
        participant Confirm as Confirm shipments macro
        participant Used as invSys.USED
        participant Made as invSys.MADE
        participant Log as ShippingLog
    end
    box rgb(239,233,250) Post shipment
        participant ShipCol as invSys.SHIPMENTS column
        participant PostShipBtn as Send MADE to SHIPMENTS button
    end
    box rgb(238,238,238) UndoRedo
        participant Undo as Undo shipping macro
        participant Redo as Redo shipping macro
    end

    rect rgb(222,235,255)
        Builder->>BOM: capture package header + recipe
        Builder->>invPkg: create/update managed package row (derives from invSys schema)
    end

    rect rgb(255,249,219)
        Picker->>Tally: add/merge package (sum qty, concat refs)
        Tally->>Assembly: rebuild component requirements
        Tally->>ShipAgg: rebuild package aggregation
        Tally-->>DeleteGuard: row deleted in ShippingTally
        DeleteGuard-->>Assembly: subtract component demand (BOM effect)
        DeleteGuard-->>ShipAgg: subtract package quantity

        HoldToggle->>HoldList: toggle hide/unhide columns (show Unshipped pane)
        Tally-->>SendHoldBtn: ctrl-select rows needing hold
        SendHoldBtn->>HoldList: append REF/ITEM + held quantity
        SendHoldBtn->>Assembly: subtract held BOM demand
        SendHoldBtn->>ShipAgg: subtract held package qty
        HoldList-->>ReturnHoldBtn: operator selects held rows to release
        ReturnHoldBtn->>Tally: push rows back into ShippingTally
        ReturnHoldBtn->>Assembly: add BOM demand back
        ReturnHoldBtn->>ShipAgg: add package qty back
    end

    rect rgb(231,250,233)
        ShipAgg->>Confirm: click Confirm shipments
        alt validation OK + inventory available
            Confirm-->>Used: add needed quantities (per component ROW) to USED
            Confirm-->>Made: add package quantities (per package ROW) to MADE
            Confirm-->>Log: append ShippingLog rows per REF_NUMBER
            Confirm-->>Tally: clear staging (ShippingTally/Assembly/Shipments)
            PostShipBtn->>ShipCol: move confirmed MADE qty into invSys.SHIPMENTS column
        else validation fails or inventory short
            Confirm-->>Confirm: show error&#59; no writes
        end
    end

    rect rgb(239,233,250)
        PostShipBtn->>ShipCol: operator can also post MADE qty later if needed
    end

    %% undo operations (gray)
    rect rgb(238,238,238)
        Undo->>Tally: restore ShippingTally rows
        Undo->>Assembly: restore ShippingAssembly
        Undo->>ShipAgg: restore Shipments
        Undo->>Used: revert USED deltas
        Undo->>Made: revert MADE deltas
        Undo->>Log: delete ShippingLog rows created by last confirm

        Redo->>Tally: reapply last undone tally rows
        Redo->>Assembly: rebuild component view
        Redo->>ShipAgg: rebuild package aggregation
        Redo->>Used: reapply USED deltas
        Redo->>Made: reapply MADE deltas
        Redo->>Log: reinsert ShippingLog rows
    end
