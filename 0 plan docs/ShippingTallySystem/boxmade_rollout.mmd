flowchart TD
    classDef phase fill:#bfdbfe,stroke:#1d4ed8,color:#0f172a,font-weight:bold;
    classDef task fill:#e0f2fe,stroke:#0ea5e9,color:#0f172a;
    classDef check fill:#dcfce7,stroke:#16a34a,color:#064e3b;

    P0["Phase 0 – Baseline\nBTN_CONFIRM/BTN_BOXES both mutate invSys directly"]:::phase
    P1["Phase 1 – Confirm gate solidified\nBTN_CONFIRM only stages usage (invSys.USED) + logging"]:::phase
    P2["Phase 2 – Delta builders\nShipments code emits UsedDelta[] / MadeDelta[] per ROW"]:::phase
    P3["Phase 3 – modInvMan helpers\nRefactor DeductUsed_Click & AddMadeItems_Click into Apply* routines\nmerge modInvLogs into modInvMan"]:::phase
    P4["Phase 4 – BTN_BOXES_MADE pilot\nCall ApplyUsedDeltas/ApplyMadeDeltas, verify InventoryLog parity"]:::phase
    P5["Phase 5 – Rollout to BTN_TO_TOTALINV / BTN_TO_SHIPMENTS / BTN_SHIPMENTS_SENT\nremove legacy logging code"]:::phase

    P0 -->|box builder + confirm tests| P1
    P1 -->|delta unit tests| P2
    P2 -->|API contract defined| P3
    P3 -->|inventory regression| P4
    P4 -->|shipping full flow QA| P5

    Check1["Checkpoint: BTN_CONFIRM only stages usage\n(no TOTAL_INV mutations, logs correct)"]:::check
    Check2["Checkpoint: BTN_BOXES_MADE via modInvMan matches legacy math/logs"]:::check
    Check3["Checkpoint: All shipping buttons use modInvMan helpers"]:::check

    P1 --> Check1 --> P2
    P4 --> Check2 --> P5
    P5 --> Check3
