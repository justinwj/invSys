flowchart LR
    classDef btn fill:#ffd166,stroke:#c05621,color:#1a202c,font-weight:bold;
    classDef ship fill:#d6e4ff,stroke:#1d4ed8,color:#0f172a;
    classDef inv fill:#fde68a,stroke:#b45309,color:#1f2937;
    classDef proc fill:#c7f9cc,stroke:#047857,color:#0f172a;
    classDef log fill:#ffe4e6,stroke:#be123c,color:#1f2937;

    subgraph Shipments["ShipmentsTally side (modTS_Shipments)"]
        BTN_CON["BTN_CONFIRM_INV"]:::btn
        PROC_CON["ConfirmInventory()\n- stage invSys.USED per AggregateBoxBOM\n- write Shipments logs only"]:::proc
        STAGED_USED["invSys.USED staging cells\n(ROW indexed)"]:::ship
        BTN_BOX["BTN_BOXES_MADE"]:::btn
        PROC_PAYLOAD["BuildBoxesMadePayload()\n- read staged rows\n- emit UsedDelta[] + MadeDelta[]"]:::proc
        DELTA_PACKET["DeltaPacket\nUsedDelta[ROW,QTY,...]\nMadeDelta[ROW,QTY,...]"]:::ship
        LOG_SHIP["Shipments log tables"]:::log

        BTN_CON --> PROC_CON --> STAGED_USED
        STAGED_USED --> BTN_BOX
        BTN_BOX --> PROC_PAYLOAD --> DELTA_PACKET
        PROC_CON --> LOG_SHIP
        PROC_PAYLOAD --> LOG_SHIP
    end

    subgraph Inventory["InventoryManagement side (modInvMan)"]
        APPLY_USED["ApplyUsedDeltas()\n- consumes UsedDelta[]\n- per-row invSys.TOTAL_INV -= qty\n- maintains invSys.USED undo stack"]:::proc
        APPLY_MADE["ApplyMadeDeltas()\n- consumes MadeDelta[]\n- adds to invSys.MADE"]:::proc
        INV_TABLE["invSys table"]:::inv
        INV_LOG["InventoryLog"]:::log

        DELTA_PACKET --> APPLY_USED --> INV_TABLE
        APPLY_USED --> INV_LOG
        DELTA_PACKET --> APPLY_MADE --> INV_TABLE
        APPLY_MADE --> INV_LOG
    end

    APPLY_USED -->|status + new totals| BTN_BOX
    APPLY_MADE -->|ready for BTN_TO_TOTALINV| Shipments
